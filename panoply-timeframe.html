<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-icons/core-icons.html">
<link rel="import" href="bower_components/core-pages/core-pages.html">
<link rel="import" href="bower_components/paper-ripple/paper-ripple.html">

<polymer-element name="panoply-timeframe-month" attributes="month start end">
    <template>
        <style type="text/css">
        * {
            font-size: 12px;
        }
        table {
            border: 0;
            border-bottom: 1px solid rgb(238, 238, 238);
            opacity: inherit;
        }
        th, td {
            padding: 5px;
            text-align: center;
        }

        td {
            border-left: 1px solid rgb(238, 238, 238);
            border-top: 1px solid rgb(238, 238, 238);
        }
        td:last-child {
            /* separation between months */
            border-right: 1px solid rgb(238, 238, 238);
        }
        td[future] {
            background: rgba(238, 238, 238, .6);
            color: rgba( 0, 0, 0, .5 )
        }
        td[inrange] {
            background: #2980b9;
            color: white;
        }
        paper-ripple {
            cursor: pointer;
            color: #2980b9;
        }
        </style>
        <table cellspacing="0" cellpadding="0">
            <thead>
                <tr>
                    <th colspan="7">{{ title }}</th>
                </tr>
                <tr>
                    <th>S</th>
                    <th>M</th>
                    <th>T</th>
                    <th>W</th>
                    <th>T</th>
                    <th>F</th>
                    <th>S</th>
                </tr>
            </thead>
            <tbody>
                <template repeat="{{ week in weeks }}">
                    <tr>
                        <template repeat="{{ day in week }}">
                            <td relative 
                                future?="{{ day.future }}"
                                inrange?="{{ day.inrange }}">
                                {{ day || "&nbsp;" }}
                                <paper-ripple fit
                                    hidden?="{{ !day || day.future }}"
                                    on-core-transitionend="{{ select }}"></paper-ripple>
                            </td>
                        </template>
                    </tr>
                </template>
            </tbody>
        </table>
    </template>
    <script type="text/javascript">
    Polymer({
        observe: {
            "start": "monthChanged",
            "end": "monthChanged",
        },
        select: function ( ev, data, el ) {
            var day = +el.templateInstance.model.day.toString();
            var date = new Date( this.month );
            date.setDate( day );
            this.fire( "timeframe-select", date );
        },
        monthChanged: function () {
            if ( !this.month ) return;
            this.title = [
                "Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
            ][ this.month.getMonth() ] + " " + this.month.getFullYear();

            var now = new Date();

            // construct the array of weeks and days within the month 
            var weeks = [ [] ];
            var t = new Date( this.month );
            while( t.getMonth() == this.month.getMonth() ) {
                var day = new String( t.getDate() );
                day.future = t > now;
                day.inrange = t >= this.start && t <= this.end;

                weeks[ weeks.length - 1 ].push( day );

                // starting a new week
                if ( t.getDay() == 6 ) {
                    weeks.push( [] );
                }

                // increment to the next day
                t.setDate( t.getDate() + 1 )
            }

            // pad the first week
            while ( weeks[ 0 ].length < 7 ) {
                weeks[ 0 ].unshift( null );
            }

            // pad the last week
            while ( weeks[ weeks.length - 1 ].length < 7 ) {
                weeks[ weeks.length - 1 ].push( null )
            }

            // add a final last week for UI alignment
            while ( weeks.length < 6 ) {
                weeks.push( [ null, null, null, null, null, null, null ] )
            }

            this.weeks = weeks;
        }
    })
    </script>
</polymer-element>

<polymer-element name="panoply-timeframe" attributes="start end">
    <template>
        <style type="text/css" shim-shadowdom>
        :host {
            position: relative;
        }

        #arrow-back, #arrow-forward {
            background: white;
            position: absolute;
            top: 0;
        }
        #arrow-back { left: 0 }
        #arrow-forward { right: 0 }

        .absolute {
            position: absolute;
        }
        
        panoply-timeframe-month {
            -webkit-transition: -webkit-transform .25s;
               -moz-transition:    -moz-transform .25s;
                -ms-transition:     -ms-transform .25s;
                    transition:         transform .25s;

            -webkit-transform: translateX( 0 );
               -moz-transform: translateX( 0 );
                -ms-transform: translateX( 0 );
                    transform: translateX( 0 );
        }
        </style>
        <div relative layout horizontal id="months"
            style="overflow: hidden"
            on-timeframe-select="{{ select }}"
            on-scroll="{{ scroll }}">

            <template repeat="{{ month, idx in months }}">
                <panoply-timeframe-month
                    month="{{ month }}"
                    start="{{ start }}"
                    end="{{ end }}"
                    class="{{ month.class }}"
                    style="{{ month.left | _translate }}"
                    on-transitionend="{{ transitionend }}">
                </panoply-timeframe-month>
            </template>
        </div>
        <div relative id="arrow-back">
            <core-icon icon="arrow-back"></core-icon>
            <paper-ripple fit 
                class="circle recenteringTouch"
                on-click="{{ back }}"></paper-ripple>
        </div>
        <div relative id="arrow-forward">
            <core-icon icon="arrow-forward"></core-icon>
            <paper-ripple fit 
                class="circle recenteringTouch"
                on-click="{{ forward }}"></paper-ripple>
        </div>
    </template>
    <script type="text/javascript">
    Polymer({
        show: 2,
        ready: function () {
            var now = new Date();
            var months = [];
            for ( var i = 0 ; i < this.show ; i += 1 ) {
                var month = new Date( now.getFullYear(), now.getMonth() - i );
                month.left = 0;
                months.unshift( month );
            }

            this.months = months;

            // we start by appending one absolutely-positioned month
            // in order to identify it later when the forward button is clicked
            // due to it's left attribute equaling -100 instead of the default
            // zeros
            this.append();
        },

        // date selection, either starts or ends the selection
        select: function ( ev, date ) {
            console.log( "SELECT ", date )
            if ( this.start ) {
                this.end = date;
            } else {
                this.start = date;
                this.end = date;
            }
        },

        // back button clicked, shift left
        forward: function () {
            var last = this.months.slice( -1 )[ 0 ];
            if ( last.left == -100 ) {
                this.append();
            }
            this.async( this.shift, [ -1 ], 100 );
        },

        // back button clicked, shift right
        back: function () {
            var first = this.months[ 0 ];
            if ( first.left == 0 ) {
                this.prepend();
            }
            
            this.async( this.shift, [ +1 ], 100 );
        },

        // appends the succeeding month to the list
        append: function () {
            var last = this.months.slice( -1 )[ 0 ];
            var month = new Date( last.getFullYear(), last.getMonth() + 1 );
            month.class = "absolute";
            month.left = 0;
            this.months.push( month );
        },

        // prepends the precending month to the list
        prepend: function () {
            var first = this.months[ 0 ];
            var month = new Date( first.getFullYear(), first.getMonth() - 1 );
            month.class = "absolute";
            month.left = -100;
            this.months.unshift( month );
        },

        // push all of the months left or right, depending on the sign
        // of the direction argument
        shift: function ( dir ) {
            for ( var i = 0 ; i < this.months.length ; i += 1 ) {
                this.months[ i ].left += dir * 100;
            }
        },
        _translate: function ( v ) {
            return [
                "-webkit-transform: translateX(" + v + "%)",
                   "-moz-transform: translateX(" + v + "%)",
                    "-ms-transform: translateX(" + v + "%)",
                        "transform: translateX(" + v + "%)",
            ].join( "; " );
        },
    })
    </script>
</polymer-element>