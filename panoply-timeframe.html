<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-icons/core-icons.html">
<link rel="import" href="bower_components/core-pages/core-pages.html">
<link rel="import" href="bower_components/paper-ripple/paper-ripple.html">

<polymer-element name="panoply-timeframe-month" attributes="month start end">
    <template>
        <style type="text/css">
        * {
            font-size: 12px;
        }
        table {
            border: 0;
            border-bottom: 1px solid rgb(238, 238, 238);
            opacity: inherit;
        }
        th, td {
            padding: 5px;
            text-align: center;
        }
        td {
            border-left: 1px solid rgb(238, 238, 238);
            border-top: 1px solid rgb(238, 238, 238);
        }
        td[future] {
            background: rgba(238, 238, 238, .6);
            color: rgba( 0, 0, 0, .5 )
        }
        td[inrange] {
            background: #2980b9;
            color: white;
        }
        paper-ripple {
            cursor: pointer;
            color: #2980b9;
        }
        </style>
        <table cellspacing="0" cellpadding="0">
            <thead>
                <tr>
                    <th colspan="7">{{ title }}</th>
                </tr>
                <tr>
                    <th>S</th>
                    <th>M</th>
                    <th>T</th>
                    <th>W</th>
                    <th>T</th>
                    <th>F</th>
                    <th>S</th>
                </tr>
            </thead>
            <tbody>
                <template repeat="{{ week in weeks }}">
                    <tr>
                        <template repeat="{{ day in week }}">
                            <td relative 
                                future?="{{ day.future }}"
                                inrange?="{{ day.inrange }}">
                                {{ day || "&nbsp;" }}
                                <paper-ripple fit
                                    hidden?="{{ !day || day.future }}"
                                    on-core-transitionend="{{ select }}"></paper-ripple>
                            </td>
                        </template>
                    </tr>
                </template>
            </tbody>
        </table>
    </template>
    <script type="text/javascript">
    Polymer({
        observe: {
            "start": "monthChanged",
            "end": "monthChanged",
        },
        select: function ( ev, data, el ) {
            var day = +el.templateInstance.model.day.toString();
            var date = new Date( this.month );
            date.setDate( day );
            this.fire( "timeframe-select", date );
        },
        monthChanged: function () {
            if ( !this.month ) return;
            this.title = [
                "Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
            ][ this.month.getMonth() ] + " " + this.month.getFullYear();

            var now = new Date();

            // construct the array of weeks and days within the month 
            var weeks = [ [] ];
            var t = new Date( this.month );
            while( t.getMonth() == this.month.getMonth() ) {
                var day = new String( t.getDate() );
                day.future = t > now;
                day.inrange = t >= this.start && t <= this.end;

                weeks[ weeks.length - 1 ].push( day );

                // starting a new week
                if ( t.getDay() == 6 ) {
                    weeks.push( [] );
                }

                // increment to the next day
                t.setDate( t.getDate() + 1 )
            }

            // pad the first week
            while ( weeks[ 0 ].length < 7 ) {
                weeks[ 0 ].unshift( null );
            }

            // pad the last week
            while ( weeks[ weeks.length - 1 ].length < 7 ) {
                weeks[ weeks.length - 1 ].push( null )
            }

            // add a final last week for UI alignment
            while ( weeks.length < 6 ) {
                weeks.push( [ null, null, null, null, null, null, null ] )
            }


            this.weeks = weeks;
        }
    })
    </script>
</polymer-element>

<polymer-element name="panoply-timeframe" attributes="start end">
    <template>
        <style type="text/css" shim-shadowdom>
        #arrow-back {
            position: absolute;
            top: 0;
            left: 0;
        }
        #arrow-forward {
            position: absolute;
            top: 0;
            right: 0;
        }
        [absolute] {
            position: absolute;
        }
        panoply-timeframe-month {
            transition: transform .25s, opacity .25s;
            opacity: 1;
        }
        panoply-timeframe-month.fade {
            opacity: 0.3;
        }
        </style>
        <div relative layout horizontal
            on-timeframe-select="{{ select }}">

            <template repeat="{{ month, idx in months }}">
                <panoply-timeframe-month 
                    relative?="{{ !month.absolute }}"
                    absolute?="{{ month.absolute }}"
                    month="{{ month }}"
                    start="{{ start }}"
                    end="{{ end }}"
                    class="{{ month.class }}"
                    style="transform: translateX( {{ month.left }}% );"
                    on-transitionend="{{ transitionend }}">
                </panoply-timeframe-month>
            </template>

            <div relative id="arrow-back">
                <core-icon icon="arrow-back"></core-icon>
                <paper-ripple fit 
                    class="circle recenteringTouch"
                    on-core-transitionend="{{ back }}"></paper-ripple>
            </div>
            <div relative id="arrow-forward">
                <core-icon icon="arrow-forward"></core-icon>
                <paper-ripple fit 
                    class="circle recenteringTouch"
                    on-core-transitionend="{{ forward }}"></paper-ripple>
            </div>
        </div>
    </template>
    <script type="text/javascript">
    Polymer({
        ready: function () {
            var months = [
                // new Date( "Apr 2015" ),
                new Date( "May 2015" ),
                new Date( "Jun 2015" ),
                // new Date( "Jul 2015" )
            ];
            months[ 0 ].visible = true;
            months[ 0 ].left = 0;
            months[ 1 ].visible = true;
            months[ 1 ].left = 0;
            this.months = months;
        },
        select: function ( ev, date ) {
            console.log( "SELECT ", date )
            if ( this.start ) {
                this.end = date;
            } else {
                this.start = date;
                this.end = date;
            }
        },
        forward: function () {
            var last = this.months[ this.months.length - 1 ];
            var month = new Date( last );
            month.setMonth( month.getMonth() + 1 );

            month.left = last.left + 100;
            month.absolute = true;
            // month.class = "fade";
            this.months.push( month );

            this.async( function () {
                month.class = "";
                // this.months[ this.months.length - 3 ].class = "fade";
                for ( var i = 0 ; i < this.months.length ; i += 1 ) {
                    this.months[ i ].left = ( this.months[ i ].left || 0 ) - 100
                }
            })
        },
        back: function () {
            var first = this.months[ 0 ];
            var month = new Date( first );
            month.setMonth( month.getMonth() - 1 );
            month.left = first.left - 100;
            month.absolute = true;
            // month.class = "fade";
            this.months.unshift( month );

            this.async( function () {
                month.class = "";
                // this.months[ 2 ].class = "fade";
                for ( var i = 0 ; i < this.months.length ; i += 1 ) {
                    this.months[ i ].left = ( this.months[ i ].left || 0 ) + 100
                }
            })
            
        },
    })
    </script>
</polymer-element>